---
title: "P8108 Survival Analysis Heart Failure"
author: "Yi Huang"
date: "2023-11-10"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warnings = FALSE,
                      message = FALSE)
```

## Preparation
install and read packages, read functions
```{r set up}
#----------------------------------------------------------------
# CLEAR ENVIRONMENT
#----------------------------------------------------------------
rm(list = ls())

#----------------------------------------------------------------
# INSTALL PACKAGES
#----------------------------------------------------------------
packages <- c("dplyr", "tidyverse", "readxl", 
              "survival", "KMsurv", 
              # ggsurvplot()
              "survminer",
              # stepwiseCox()
              "StepReg")


# Install missing packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages], dependencies = TRUE)
}

# Load packages invisibly
invisible(lapply(packages, library, character.only = TRUE))

# Remove variables associated with package installation
rm(packages, installed_packages)

# Read function
source("shared_code/stepwiseCox.R", local = TRUE)
# source("shared_code/stepwiseCox.R", local = TRUE)$value
```


## Load data

```{r}
# read data
data <- read_csv("data/heart_failure.csv")

# # data cleaning
data <- data |>
  arrange(TIME) |>
  janitor::clean_names() |>
  mutate(gender = factor(gender),
         smoking = factor(smoking),
         diabetes = factor(diabetes),
         bp = factor(bp),
         # event = factor(event),
         anaemia = factor(anaemia)) |>
  rename(pletelets = pletelets)|>
  mutate(ef_cat = case_when(
    ejection_fraction <= 30 ~ "Low",
    ejection_fraction > 30 & ejection_fraction < 45 ~ "Medium",
    ejection_fraction >= 45 ~ "High"
  ))
```

## Cox model

**Full model**
```{r}
# use survival to fit a cox model
cox_model <- coxph(Surv(time, event) ~ gender + smoking + diabetes + bp + anaemia + age + ejection_fraction + sodium + creatinine + pletelets + cpk, data = data)
summary(cox_model)
```


```{r example}
# # stepwiseCox example
# lung <- survival::lung
# 
# my.data <- na.omit(lung)
# my.data$status
# 
# my.data$status1 <- ifelse(my.data$status==2,1,0)
# 
# data <- my.data
# 
# formula = Surv(time, status1) ~ . - status 
# 
# stepwiseCox(formula=formula,
#             data=my.data,
#             selection="bidirection",
#             select="HQ",
#             method="efron")
```

## Variable Selection

```{r}
stepwise_data <- read_csv("data/heart_failure.csv")
## data cleaning for stepwiseCox, variables need to be all numeric
stepwise_data <- stepwise_data |>
  arrange(TIME) |>
  janitor::clean_names()

# Variable selection using stepwise Cox model using Sl
stepwise_model1 <- stepwiseCox(Surv(time, event) ~ gender + smoking + diabetes + bp + anaemia + age + ejection_fraction + sodium + creatinine + pletelets + cpk, data = stepwise_data)

stepwise_model1
# 7 variables are selected: age, ejection_fraction, creatinine, bp, anaemia, cpk, sodium   

# # Variable selection using stepwise Cox model using AIC
# stepwise_model2 <- stepwiseCox(Surv(time, event) ~ gender + smoking + diabetes + bp + anaemia + age + ejection_fraction + sodium + creatinine + pletelets + cpk, select = "AIC", data = stepwise_data)
# stepwise_model2
# same as SL, 7 variables: age, ejection_fraction, creatinine, bp, anaemia, cpk, sodium   

stepwise_model3 <- stepwiseCox(Surv(time, event) ~ gender + smoking + diabetes + bp + anaemia + age + ejection_fraction + sodium + creatinine + pletelets + cpk, select = "AICc", data = stepwise_data)
stepwise_model3
# AICc 8 variables: age, ejection_fraction, creatinine, bp, anaemia, cpk, sodium, gender   
```



**consider transformation on left-skewed predictors**

```{r}
stepwise_data <- stepwise_data %>%
  mutate(logcpk = log(cpk+1),
         logcre=log(creatinine+1))

# Variable selection using stepwise Cox model using SL
stepwise_model4 <- stepwiseCox(Surv(time, event) ~ gender + smoking + diabetes + bp + 
                                anaemia + age + ejection_fraction + sodium + logcre + 
                                pletelets + logcpk, data = stepwise_data)
stepwise_model4
# 6 avriables: logcre, age, ejection_fraction, bp, anaemia, sodium  

# Variable selection using stepwise Cox model using SL
stepwise_model5 <- stepwiseCox(Surv(time, event) ~ gender + smoking + diabetes + bp + 
                                anaemia + age + ejection_fraction + sodium + logcre + 
                                pletelets + logcpk, select = "AIC", data = stepwise_data)
stepwise_model5
# same as SL 6 avriables: logcre, age, ejection_fraction, bp, anaemia, sodium  
```


## Check assumptions for Cox model

**full model**
```{r}
# Check assumptions with cox.zph
# full model
cox_zph <- cox.zph(cox_model)
plot(cox_zph) # Residual plots

# Plot survival curves
ggsurvplot(survfit(cox_model), data = data, conf.int = TRUE)
```

**Refit model with variables selected from stepwiseCox**
```{r}
# refit a model with 7 selected variables 
# bp, anaemia, age, ejection_fraction, sodium, creatinine, cpk
step_model <- coxph(Surv(time, event) ~ bp + anaemia + age + ejection_fraction + sodium + 
                      creatinine + cpk, data = stepwise_data)
summary(step_model)

# Check assumptions with model obtained from stepwiseCox
cox_step <- cox.zph(step_model)
plot(cox_step) # Residual plots

# Plot survival curves
ggsurvplot(survfit(step_model), data = data, conf.int = TRUE)
```

**Refit model with variables selected from stepwiseCox**
log transform on left-skewed predictors
```{r}
# refit a model with 6 selected variables 
# logcre,age, ejection_fraction, bp, anaemia, sodium
step_model4 <- coxph(Surv(time, event) ~ log(creatinine+1)+age + ejection_fraction + bp +
                       anaemia + sodium, data = stepwise_data)
summary(step_model4)

# Check assumptions with model obtained from stepwiseCox
cox_step4 <- cox.zph(step_model4)
plot(cox_step4) # Residual plots

# Plot survival curves
ggsurvplot(survfit(step_model4), data = data, conf.int = TRUE)
```

**Schoenfeld residuals**
```{r}
colon_coxph <- coxph(Surv(time, event)~ logcre+age + ejection_fraction + bp +
                       anaemia + sodium, data = stepwise_data)
ggcoxzph(cox.zph(colon_coxph), var = c("logcre"), df = 2, nsmo = 1000)

ggcoxzph(cox.zph(colon_coxph), var = c("age"), df = 2, nsmo = 1000)

ggcoxzph(cox.zph(colon_coxph), var = c("ejection_fraction"), df = 2, nsmo = 1000)

ggcoxzph(cox.zph(colon_coxph), var = c("bp"), df = 2, nsmo = 1000)

ggcoxzph(cox.zph(colon_coxph), var = c("anaemia"), df = 2, nsmo = 1000)

ggcoxzph(cox.zph(colon_coxph), var = c("sodium"), df = 2, nsmo = 1000)
```

