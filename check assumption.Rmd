---
title: "check assumption"
author: "Jiahe Deng"
output: html_document
---

```{r setup, include=FALSE}
library(survival)
library(survminer)
library(tidyverse)
library(ggplot2)
```
```{r}
# read data
raw_data <- read_csv("data/heart_failure.csv")

# clean variable names
raw_data <- raw_data |>
  arrange(TIME) |>
  janitor::clean_names()

## data cleaning, create data frame for model
model_data <- raw_data |>
  mutate(gender = factor(gender),
         smoking = factor(smoking),
         diabetes = factor(diabetes),
         bp = factor(bp),
         # event = factor(event),
         anaemia = factor(anaemia),
         logcre=log(creatinine+1),
         logcpk = log(cpk+1)) |>
  rename(pletelets = pletelets)|>
  mutate(ef_cat = factor(case_when(
    ejection_fraction <= 30 ~ "Low",
    ejection_fraction > 30 & ejection_fraction < 45 ~ "Medium",
    ejection_fraction >= 45 ~ "High"),
    levels = c("Low", "Medium", "High")))
model_data
```


```{r} 
par(mfrow = c(3, 2))
km.fit.gender=survfit(Surv(time, event)~ gender, data=model_data)
plot(km.fit.gender, fun="cumhaz", col=c("blue", "red"),
     xlab = "Time", ylab = "-log(S(t))",
     main = "Negative Log of Estimated Survival Functions for Gender")
legend("topleft", legend = c("Female", "Male"), col=c("blue", "red"), lty = 1, cex = 0.8)
plot(km.fit.gender, fun="cloglog", col=c("blue", "red"), xlab="Log(time)", ylab="log(-log(S(t)))",
     main="Log of Negative log of estimated survival function for Gender")
legend("topleft", legend = c("Female", "Male"), col=c("blue", "red"), lty = 1, cex = 0.8)

km.fit.bp=survfit(Surv(time, event)~ bp, data=model_data)
plot(km.fit.bp, fun="cumhaz", col=c("blue", "red"),
     xlab = "Time", ylab = "-log(S(t))",
     main = "Negative Log of Estimated Survival Functions for Blood Pressure")
legend("topleft", legend = c("bp=0", "bp=1"), col=c("blue", "red"), lty = 1, cex = 0.8)
plot(km.fit.bp, fun="cloglog", col=c("blue", "red"), xlab="Log(time)", ylab="log(-log(S(t)))",
     main="Log of Negative log of estimated survival function for Blood Pressure")
legend("topleft", legend = c("bp=0", "bp=1"), col=c("blue", "red"), lty = 1, cex = 0.8)

km.fit.smoke=survfit(Surv(time, event)~ smoking, model_data)
plot(km.fit.smoke, fun="cumhaz", col=c("blue", "red"),
     xlab = "Time", ylab = "-log(S(t))",
     main = "Negative Log of Estimated Survival Functions for Smoking")
legend("topleft", legend = c("No smoking", "Smoking"), col=c("blue", "red"), lty = 1, cex = 0.8)
plot(km.fit.smoke, fun="cloglog", col=c("blue", "red"), xlab="Log(time)", ylab="log(-log(S(t)))",
     main="Log of Negative log of estimated survival function for Smoking")
legend("topleft", legend = c("No smoking", "Smoking"), col=c("blue", "red"), lty = 1, cex = 0.8)

par(mfrow = c(3, 2))
km.fit.diabetes=survfit(Surv(time, event)~ diabetes, model_data)
plot(km.fit.diabetes, fun="cumhaz", col=c("blue", "red"),
     xlab = "Time", ylab = "-log(S(t))",
     main = "Negative Log of Estimated Survival Functions for Diabetes")
legend("topleft", legend = c("No Diabetes", "With Diabetes"), col=c("blue", "red"), lty = 1, cex = 0.8)
plot(km.fit.diabetes, fun="cloglog", col=c("blue", "red"), xlab="Log(time)", ylab="log(-log(S(t)))",
     main="Log of Negative log of estimated survival function for Diabetes")
legend("topleft", legend = c("No Diabetes", "With Diabetes"), col=c("blue", "red"), lty = 1, cex = 0.8)

km.fit.anaemia=survfit(Surv(time, event)~ anaemia, model_data)
plot(km.fit.anaemia, fun="cumhaz", col=c("blue", "red"),
     xlab = "Time", ylab = "-log(S(t))",
     main = "Negative Log of Estimated Survival Functions for Anaemia")
legend("topleft", legend = c("No Anaemia", "With Anaemia"), col=c("blue", "red"), lty = 1, cex = 0.8)
plot(km.fit.anaemia, fun="cloglog", col=c("blue", "red"), xlab="Log(time)", ylab="log(-log(S(t)))",
     main="Log of Negative log of estimated survival function for Anaemia")
legend("topleft", legend = c("No Anaemia", "With Anaemia"), col=c("blue", "red"), lty = 1, cex = 0.8)

km.fit.ef_cat=survfit(Surv(time, event)~ ef_cat, model_data)
plot(km.fit.ef_cat, fun="cumhaz", col=c("blue", "red","green"),
     xlab = "Time", ylab = "-log(S(t))",
     main = "Negative Log of Estimated Survival Functions for Ejection Fraction")
legend("topleft", legend = c("Low", "Mediun","High"), col=c("blue", "red","green"), lty = 1, cex = 0.8)
plot(km.fit.ef_cat, fun="cloglog", col=c("blue", "red","green"), xlab="Log(time)", ylab="log(-log(S(t)))",
     main="Log of Negative log of estimated survival function for Anaemia")
legend("topleft", legend = c("Low", "Mediun","High"), col=c("blue", "red","green"), lty = 1, cex = 0.8)

```
age+sodium + pletelets + logcre + logcpk


The Cox Proportional Hazards (PH) Model operates under two primary assumptions:
  1)Survival Cures for different strata must have proportional hazard function over time
  2)The relationship between log hazard and each covariate is linear.
By graphical approach, first assume that gender is the only covariate in the model, then take log of survival function and plot against time to estimate cumulative hazard function. From the figure(), The log survival function for the two genders that was estimated by the KM estimator are almost a straight line. From the figure(), the log log of survival function and plot against log time demonstrates a reasonable straight line with slope is 1. It can be concluded that the model with gender as the only covariates are likely to be exponential distributed. From the figure(), a plot that shows the differences between the observed KM estimates and fitted survival function for the PH model that has only gender. 





